{% extends "base.html" %}
{% load static %}
{% block content %}
<!DOCTYPE html>
<html lang="pt-br">
  <head>
    <meta charset="UTF-8" />
      <title>Dashboard de Ocorrências</title>
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <script src="https://cdn.jsdelivr.net/npm/chart.js@3.9.1/dist/chart.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.0.0"></script>
    <script>
      // Registra o plugin ChartDataLabels globalmente
      Chart.register(ChartDataLabels);
    </script>
   
    <style>
      canvas {
        max-height: 300px;
      }
    </style>
  </head>
  <body>
    <div class="container md-2">
        <div class="alert alert-info">
          <h2 class="md-2 text-center">Dashboard de Ocorrências</h2>
        </div>

      <!-- Filtros -->
      <form id="filtros" class="row g-3">
        <div class="col-md-2">
          <label for="data_inicio" class="form-label">Data Início</label>
          <input
            type="date"
            id="data_inicio"
            name="data_inicio"
            class="form-control"
          />
        </div>
        <div class="col-md-2">
          <label for="data_fim" class="form-label">Data Fim</label>
          <input
            type="date"
            id="data_fim"
            name="data_fim"
            class="form-control"
          />
        </div>
        <div class="col-md-2">
          <label for="sexo" class="form-label">Sexo</label>
          <select id="sexo" name="sexo" class="form-select">
            <option value="">Todos</option>
            {% for s in sexos %}
            <option value="{{ s.id }}">{{ s.nome }}</option>
            {% endfor %}
          </select>
        </div>
        <div class="col-md-2">
          <label for="tipo" class="form-label">Tipo</label>
          <select id="tipo" name="tipo" class="form-select">
            <option value="">Todos</option>
            {% for t in tipos %}
            <option value="{{ t.id }}">{{ t.nome }}</option>
            {% endfor %}
          </select>
        </div>
        <div class="col-md-2">
          <label for="cidade" class="form-label">Cidade</label>
          <select id="cidade" name="cidade" class="form-select">
            <option value="">Todas</option>
            {% for c in cidades %}
            <option value="{{ c.id }}">{{ c.nome }}</option>
            {% endfor %}
          </select>
        </div>
        <div class="col-md-2">
          <label for="faixa_etaria" class="form-label">Faixa Etária</label>
          <select id="faixa_etaria" name="faixa_etaria" class="form-select">
            <option value="">Todas</option>
                <option value="0-10">0 até 10 anos</option>
                <option value="11-20">11 até 20 anos</option>
                <option value="21-30">21 até 30 anos</option>
                <option value="31-40">31 até 40 anos</option>
                <option value="41-50">41 até 50 anos</option>
                <option value="51-60">51 até 60 anos</option>
                <option value="61-70">61 até 70 anos</option>
                <option value="71-80">71 até 80 anos</option>
                <option value="81-90">81 até 90 anos</option>
                <option value="91-100">91 até 100 anos</option>
                <option value="PREJUDICADO">Prejudicado</option>
          </select>
        </div>
        <div class="col-md-12 text-end">
          <button type="submit" class="btn btn-warning mt-2">Atualizar</button>
        </div>
      </form>

      <hr class="my-4" />

      <!-- Gráficos -->
      <div class="row">
        <div class="col-md-6 mb-4">
          <h5>Ocorrências por Mês</h5>
          <canvas id="graficoMes"></canvas>
        </div>
        <div class="col-md-6 mb-4">
          <h5>Ocorrências por Sexo</h5>
          <canvas id="graficoSexo"></canvas>
        </div>
        <div class="col-md-6 mb-4">
          <h5>Ocorrências por Faixa Etária</h5>
          <canvas id="graficoIdade"></canvas>
        </div>
        <div class="col-md-6 mb-4">
          <h5>Top 10 Cidades</h5>
          <canvas id="graficoCidade"></canvas>
        </div>
      </div>
    </div>
    <script>
      let graficoMes, graficoSexo, graficoIdade, graficoCidade;
    
      // Função para gerar cores com base no valor (gradiente suave)
      function getColorForValue(value, maxValue) {
        let ratio = value / maxValue;
        
        // Cores base para o gradiente
        const verde = { r: 43, g: 168, b: 126 };    // #2BA87E
        const amarelo = { r: 255, g: 215, b: 0 };   // #FFD700
        const vermelho = { r: 236, g: 84, b: 84 };  // #EC5454
        
        let r, g, b;
        
        if (ratio <= 0.33) {
          // Gradiente de verde (mais claro) para verde (mais escuro)
          const subRatio = ratio / 0.33;
          r = verde.r;
          g = verde.g;
          b = verde.b;
          
          // Ajusta a intensidade para criar variação
          const fator = 0.7 + (0.3 * subRatio);
          r = Math.round(r * fator);
          g = Math.round(g * fator);
          b = Math.round(b * fator);
        } 
        else if (ratio <= 0.66) {
          // Gradiente de verde para amarelo
          const subRatio = (ratio - 0.33) / 0.33;
          r = Math.round(verde.r + subRatio * (amarelo.r - verde.r));
          g = Math.round(verde.g + subRatio * (amarelo.g - verde.g));
          b = Math.round(verde.b + subRatio * (amarelo.b - verde.b));
        } 
        else {
          // Gradiente de amarelo para vermelho
          const subRatio = (ratio - 0.66) / 0.34;
          r = Math.round(amarelo.r + subRatio * (vermelho.r - amarelo.r));
          g = Math.round(amarelo.g + subRatio * (vermelho.g - amarelo.g));
          b = Math.round(amarelo.b + subRatio * (vermelho.b - amarelo.b));
        }
        
        // Garante que os valores estão dentro do intervalo válido (0-255)
        r = Math.min(255, Math.max(0, r));
        g = Math.min(255, Math.max(0, g));
        b = Math.min(255, Math.max(0, b));
        
        // Retorna a cor em formato hexadecimal
        return `rgb(${r}, ${g}, ${b})`;
      }
    
      // Função para atribuir cores fixas ao gráfico de sexo
      function getSexoColor(label) {
        if (label.toLowerCase() === "masculino") {
          return "#0268D4"; // Azul para Masculino
        } else if (label.toLowerCase() === "feminino") {
          return "#EA979D"; // Rosa para Feminino
        }
        return "#2BA87E"; // Verde para Outros
      }
    
      function criarOuAtualizarGrafico(ctx, tipo, dados, cor = "indigo") {
        if (ctx.chart) ctx.chart.destroy();
        ctx.chart = new Chart(ctx, {
          type: tipo,
          data: {
            labels: dados.labels,
            datasets: [
              {
                label: "Total",
                data: dados.dados,
                backgroundColor: cor,
                borderColor: cor,
                borderWidth: 1,
              },
            ],
          },
          options: {
            responsive: true,
            scales: {
              x: {
                grid: {
                  display: false  // Desativa a grade no eixo X
                }
              },
              y: {
                grid: {
                  display: false  // Desativa a grade no eixo Y
                }
              }
            },
            plugins: {
              legend: { display: false },
              tooltip: {
                enabled: true,
                callbacks: {
                  label: function(context) {
                    return `Total: ${context.raw}`;
                  }
                }
              },
              datalabels: {
                display: true, // Habilitar a exibição dos valores
                color: "white", // Cor do texto dos valores
                font: {
                  weight: "bold", // Estilo da fonte
                  size: 12, // Tamanho da fonte
                },
                formatter: (value) => value, // Exibe os valores diretamente
                padding: 4,
                backgroundColor: "rgba(70, 70, 70, 0.7)", // Fundo semi-transparente mais suave
                borderRadius: 3,
                borderWidth: 1,
                borderColor: "rgba(255, 255, 255, 0.7)",
                // Configurações específicas para diferentes tipos de gráficos
                align: function(context) {
                  // Para gráficos de pizza, centraliza os rótulos
                  if (context.chart.config.type === 'pie') {
                    return 'center';
                  }
                  // Para gráficos de barra, coloca os rótulos no topo
                  return 'top';
                },
                anchor: function(context) {
                  // Para gráficos de pizza, centraliza os rótulos
                  if (context.chart.config.type === 'pie') {
                    return 'center';
                  }
                  // Para gráficos de barra, ancora no final da barra
                  return 'end';
                },
                offset: function(context) {
                  // Para gráficos de pizza, não aplica offset
                  if (context.chart.config.type === 'pie') {
                    return 0;
                  }
                  // Para gráficos de barra, aplica um pequeno offset para cima
                  return -5;
                },
              },
            },
          },
        });
      }
    
      function atualizarGraficos() {
        const params = new URLSearchParams(
          new FormData(document.getElementById("filtros"))
        );
    
        fetch("{% url 'dashboard_dados' %}?" + params)
          .then((response) => response.json())
          .then((data) => {
            // Gráfico de Ocorrências por Mês (Barra) - Cores dinâmicas
            const maxMesValue = Math.max(...data.mes.dados);
            const coresMes = data.mes.dados.map(value => getColorForValue(value, maxMesValue));
            criarOuAtualizarGrafico(
              document.getElementById("graficoMes"),
              "bar",
              data.mes,
              coresMes
            );
    
            // Gráfico de Ocorrências por Sexo (Pizza) - Cores fixas
            const coresSexo = data.sexo.labels.map(label => getSexoColor(label));
            criarOuAtualizarGrafico(
              document.getElementById("graficoSexo"),
              "pie",
              data.sexo,
              coresSexo  // Cores definidas para o gráfico de sexo
            );
    
            // Gráfico de Ocorrências por Faixa Etária (Barra) - Cores dinâmicas
            const maxIdadeValue = Math.max(...data.idade.dados);
            const coresIdade = data.idade.dados.map(value => getColorForValue(value, maxIdadeValue));
            criarOuAtualizarGrafico(
              document.getElementById("graficoIdade"),
              "bar",
              data.idade,
              coresIdade
            );
    
            // Gráfico de Top 10 Cidades (Barra) - Cores dinâmicas
            const maxCidadeValue = Math.max(...data.cidade.dados);
            const coresCidade = data.cidade.dados.map(value => getColorForValue(value, maxCidadeValue));
            criarOuAtualizarGrafico(
              document.getElementById("graficoCidade"),
              "bar",
              data.cidade,
              coresCidade
            );
          });
      }
    
      document
        .getElementById("filtros")
        .addEventListener("submit", function (e) {
          e.preventDefault();
          atualizarGraficos();
        });
    
      // Inicial
      atualizarGraficos();
    </script>
    
  </body>
</html>
{% endblock %}
